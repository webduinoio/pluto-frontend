<!DOCTYPE html>
<html lang="en">
  <head>
    <title>bitv2 ESPTool</title>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css" />
    <script type="text/javascript" src="board/webbitv1/lib/repl.js"></script>
    <script src="board/webbitv1/lib/WebSerial.js"></script>
    <script src="board/webbitv1/lib/esptool/pako/pako_deflate.js"></script>
    <script src="board/webbitv1/lib/esptool/slip.js"></script>
    <script src="board/webbitv1/lib/esptool/md5.js"></script>
    <script src="board/webbitv1/lib/esptool/esptool.js"></script>

    <style>
      #main {
        display: flex;
        flex-direction: row;
        justify-content: center;
        align-items: center;
        width: 480px;
      }

      #btn {
        display: flex;
        flex-direction: row;
        justify-content: center;
        align-items: center;
        width: 480px;
      }

      #btnPython,
      #btnBlockly {
        margin: 0 25px;
      }

      #fw {
        background-color: #eee;
        width: 300px;
        margin-left: 90px;
      }

      .modal {
        display: none;
        position: fixed;
        z-index: 1;
        padding-top: 100px;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background-color: rgb(0, 0, 0);
        background-color: rgba(0, 0, 0, 0.4);
      }

      .modal-content {
        background-color: #fefefe;
        margin: auto;
        padding: 20px;
        border: 1px solid #888;
        width: 80%;
      }

      .close {
        color: #aaa;
        float: right;
        font-size: 28px;
        font-weight: bold;
      }

      .close:hover,
      .close:focus {
        color: black;
        text-decoration: none;
        cursor: pointer;
      }
    </style>
  </head>

  <body>
    <div style="padding: 10px">
      <h1 style="margin-left: 50px">Web:Bit v1 韌體更新工具</h1>
      <div id="main"><img src="coms/wbitv1.png" width="240px" /><br /></div>
      <div id="btn">
        <button id="btnPython" type="button">AI Python小助教</button>
        <button id="btnBlockly" type="button">Web:Bit教育版</button>
      </div>
      <br /><br />
      <div id="fw">訊息：<span id="msg">尚未連線</span></div>
      <br /><br />
      <div class="w3-light-grey" style="margin-left: 140px; width: 200px">
        <div
          id="myBar"
          class="w3-container w3-green"
          style="padding: 0px; width: 0%; display: none"
        >
          0%
        </div>
      </div>
      <div id="pythonReady2go" style="display: none">
        <h3>
          重新插拔 Web:Bit USB 後，點選 [<a
            href="https://chat.webduino.io/index.html"
            >AI Python小助教</a
          >] 開始使用
        </h3>
      </div>
      <div id="blocklyReady2go" style="display: none">
        <h3>
          重新插拔 Web:Bit USB 後，點選 [<a href="https://webbit.webduino.io/"
            >Web:Bit 教育版</a>] 開始使用
        </h3>
      </div>
    </div>

    <div id="myModal" class="modal">
      <div class="modal-content">
        <span class="close">&times;</span>
        <p>請使用Web:Bit安裝版進行韌體更新</p>
        <button id="confirmButton" type="button">開啟教學文</button>
        <button id="cancelButton" type="button">取消</button>
      </div>
    </div>

    <script>
      function progressShow() {
        myBar.style.display = "";
      }

      function progressHide() {
        myBar.style.display = "none";
      }

      function progressSet(n) {
        msg.innerHTML = n < 100 ? "燒錄中..." : "燒錄完成";
        var elem = document.getElementById("myBar");
        elem.style.width = n + "%";
        elem.innerHTML = n + "%";
      }

      btnBlockly.onclick = () => {
        var modal = document.getElementById("myModal");
        var span = document.getElementsByClassName("close")[0];
        var confirmButton = document.getElementById("confirmButton");
        var cancelButton = document.getElementById("cancelButton");

        modal.style.display = "block";

        span.onclick = function () {
          modal.style.display = "none";
        };

        cancelButton.onclick = function () {
          modal.style.display = "none";
        };

        confirmButton.onclick = function () {
          modal.style.display = "none";
          window.open(
            "https://resource.webduino.io/docs/webbit/info/ota#%E6%9B%B4%E6%96%B0%E9%9F%8C%E9%AB%94%E6%96%B9%E6%B3%95-1%EF%BC%9A%E4%BD%BF%E7%94%A8%E5%AE%89%E8%A3%9D%E7%89%88%E9%80%B2%E8%A1%8C%E6%9B%B4%E6%96%B0",
            "_blank"
          );
        };
      };

      btnPython.onclick = async () => {
        progressShow();
        esp = new ESP({
          baudrate: 115200 * 2,
        });
        await esp.init();
        esp.burn(
          [["./board/webbitv1/fw_mpy/micropython.bin", 0x0]],
          function (n) {
            progressSet(n);
          }
        );
      };
    </script>
  </body>
</html>
