<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>MQTT Publish</title>
</head>

<body>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.1.0/paho-mqtt.min.js"></script>
    <script src="https://cdn.jsdelivr.net/pyodide/v0.21.0/full/pyodide.js"></script>

    <script>
        class MQTTApp {
            constructor(userId) {
                this.userId = userId;
                this.client = new Paho.Client('wss://mqtt1.webduino.io/mqtt', userId);
                this.options = {
                    reconnect: true,
                    timeout: 900, keepAliveInterval: 30,
                    userName: 'webduino', password: 'webduino'
                };
                this.subscriptions = {}; // 存儲訂閱關係的對象
            }

            async connect() {
                this.onConnectPromise = new Promise((resolve, reject) => {
                    this.client.connect({
                        ...this.options,
                        onSuccess: () => {
                            console.log('Connected to MQTT broker');
                            resolve();
                        },
                        onFailure: (err) => {
                            console.log('Failed to connect to MQTT broker:', err);
                            reject(err);
                        }
                    });
                });
                await this.onConnectPromise;
                this.client.onMessageArrived = this.onMessageArrived.bind(this);
            }

            // MQTT message publish function
            publish(msg) {
                var payload = new Paho.Message(msg);
                payload.destinationName = this.pubTopic;
                this.client.send(payload);
                console.log("Published message: " + msg);
            }

            // MQTT message publish function
            async publishTopic(topic, msg) {
                var payload = new Paho.Message(msg);
                payload.destinationName = topic;
                this.client.send(payload);
            }

            // MQTT message subscribe function
            subscribe(topic, onMessageReceived) {
                console.log("subscribe topic: " + topic);
                if (!this.subscriptions[topic]) {
                    this.subscriptions[topic] = {
                        onMessageReceived: onMessageReceived
                    };
                    this.client.subscribe(topic);
                    //console.log(`Subscribed to topic: ${topic}`);
                } else {
                    console.warn(`Already subscribed to topic: ${topic}`);
                }
            }

            // MQTT message received handler 
            onMessageArrived(message) {
                const topic = message.destinationName;
                const payload = message.payloadString;
                if (this.subscriptions[topic] && this.subscriptions[topic].onMessageReceived) {
                    this.subscriptions[topic].onMessageReceived(payload);
                }
            }
        }

        var mqtt = new MQTTApp('pyodide-' + Math.random(1000000));
        window.mqtt = mqtt;
        async function initPyodide() {
            let pyodide = await loadPyodide(); // 等待 Pyodide 載入
            await mqtt.connect();
            mqtt.pub = mqtt.publishTopic;
            mqtt.sub = function (topic, methodName) {
                mqtt.subscribe(topic, function (msg) {
                    const callback = pyodide.globals.get(methodName);
                    callback(msg);
                });
            }

            try {
                // web:bit 範例
                // https://webbit.webduino.io/blockly/#nqnoBg471PG3Z
                await pyodide.runPythonAsync(`
                    from js import mqtt
                    def sub(msg):
                        mqtt.pub("sroom/data", "Py:{"+msg+"}");
                    mqtt.sub("r123","sub")
                    mqtt.pub("sroom/data", "OK");
                `);
            } catch (err) {
                console.error("Error calling JavaScript from Python:", err);
            }
        }

        ((async function () {
            initPyodide();
        })())        
    </script>
</body>

</html>