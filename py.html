<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>MQTT Publish</title>
  </head>

  <body>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.1.0/paho-mqtt.min.js"></script>
    <script src="https://cdn.jsdelivr.net/pyodide/v0.21.0/full/pyodide.js"></script>
    <script src="prod/js/py-mqtt.js"></script>

    <script>
      var mqtt = new MQTTApp("pyodide-" + Math.random(1000000));
      window.mqtt = mqtt;
      async function initPyodide() {
        let pyodide = await loadPyodide(); // 等待 Pyodide 載入
        await mqtt.connect();
        mqtt.pub = mqtt.publishTopic;
        mqtt.sub = function (topic, methodName) {
          mqtt.subscribe(topic, function (msg) {
            const callback = pyodide.globals.get(methodName);
            callback(msg);
          });
        };

        try {
          // web:bit 範例
          // https://webbit.webduino.io/blockly/#nqnoBg471PG3Z
          await pyodide.runPythonAsync(`
                    from js import mqtt
                    def sub(msg):
                        mqtt.pub("sroom/data", "Py:{"+msg+"}");
                    mqtt.sub("r123","sub")
                    mqtt.pub("sroom/data", "OK");
                `);
        } catch (err) {
          console.error("Error calling JavaScript from Python:", err);
        }
      }

      (async function () {
        initPyodide();
      })();
    </script>
  </body>
</html>
